{"version":3,"sources":["../../../src/plugins/validation/check_attachments.js"],"names":[],"mappings":";;;AAGA;;AAEA,IAAM,WAAW,QAAQ,UAAR,CAAX;;AAEN,OAAO,OAAP,GAAiB,UAAU,OAAV,EAAmB,QAAnB,EAA6B,MAA7B,EAAqC,MAArC,EAA6C;;AAE1D,QAAI,WAAW,KAAX,CAFsD;AAG1D,QAAI,QAAJ,EAAc;;AACV,mBAAW,IAAX,CADU;KAAd;;AAIA,WAAO,IAAP,CAAY,OAAO,IAAP,CAAZ,CAAyB,OAAzB,CAAiC,UAAC,GAAD,EAAS;;AAEtC,YAAM,aAAa,OAAO,IAAP,CAAY,GAAZ,CAAb,CAFgC;;AAItC,YAAI,WAAW,IAAX,IAAmB,SAAS,WAAT,CAAqB,KAArB,IAChB,WAAW,IAAX,IAAmB,SAAS,WAAT,CAAqB,IAArB,EAA2B;;AAEjD,gBAAM,aAAa,WAAW,QAAX,CAF8B;;AAIjD,gBAAI,CAAC,QAAQ,GAAR,CAAD,EAAe;;aAAnB;AAGA,gBAAI,CAAC,QAAQ,GAAR,EAAa,QAAb,IAAyB,CAAC,QAAQ,GAAR,EAAa,IAAb,EAAmB;;AAE9C,oBAAI,cAAc,CAAC,QAAD,EAAW;AACzB,2BAAO,IAAP,CAAY;AACR,6BAAK,GAAL;AACA,6BAAK,mBAAL;qBAFJ,EADyB;iBAA7B,MAMK,IAAI,cAAc,QAAd,IAA0B,CAAC,SAAS,GAAT,CAAD,EAAgB;AAC/C,2BAAO,IAAP,CAAY;AACR,6BAAK,GAAL;AACA,6BAAK,mBAAL;qBAFJ,EAD+C;iBAA9C;AAML,uBAAO,QAAQ,GAAR,CAAP,CAd8C;aAAlD,MAgBK;AACD,oBAAI,WAAW,IAAX,IAAmB,SAAS,WAAT,CAAqB,KAArB,EAA4B;;AAE/C,wBAAM,eAAe,QAAQ,GAAR,EAAa,SAAb,EAAwB,cAAxB,EAAwC,KAAxC,CAA8C,GAA9C,CAAf,CAFyC;AAG/C,wBAAI,aAAa,CAAb,KAAmB,OAAnB,EAA4B;AAC5B,+BAAO,QAAQ,GAAR,CAAP,CAD4B;AAE5B,+BAAO,IAAP,CAAY;AACR,iCAAK,GAAL;AACA,iCAAK,6BAAL;yBAFJ,EAF4B;qBAAhC,MAOK,IAAI,CAAC,KAAD,EAAQ,MAAR,EAAgB,KAAhB,EAAuB,OAAvB,CAA+B,aAAa,CAAb,EAAgB,iBAAhB,EAA/B,KAAuE,CAAC,CAAD,EAAI;AAChF,+BAAO,QAAQ,GAAR,CAAP,CADgF;AAEhF,+BAAO,IAAP,CAAY;AACR,iCAAK,GAAL;AACA,iCAAK,wDAAL;yBAFJ,EAFgF;qBAA/E;iBAVT;AAkBA,oBAAI,WAAW,IAAX,IAAmB,SAAS,WAAT,CAAqB,IAArB,EAA2B;;AAE9C,wBAAM,gBAAgB,QAAQ,GAAR,EAAa,QAAb,CAAsB,KAAtB,CAA4B,GAA5B,CAAhB,CAFwC;AAG9C,wBAAM,MAAM,cAAc,GAAd,EAAN,CAHwC;;AAK9C,wBAAI,WAAW,WAAW,SAAX,CAL+B;AAM9C,wBAAI,EAAE,WAAW,SAAX,YAAgC,KAAhC,CAAF,EAA0C;AAC1C,mCAAW,CAAC,QAAD,CAAX,CAD0C;qBAA9C;;AAIA,wBAAI,SAAS,OAAT,CAAiB,GAAjB,KAAyB,CAAC,CAAD,EAAI;AAC7B,+BAAO,QAAQ,GAAR,CAAP,CAD6B;AAE7B,+BAAO,IAAP,CAAY;AACR,iCAAK,GAAL;AACA,iCAAK,6CAA6C,WAAW,IAAX;yBAFtD,EAF6B;qBAAjC;iBAVJ;aAnCJ;SARJ;KAJ6B,CAAjC,CAP0D;CAA7C","file":"check_attachments.js","sourcesContent":["/**\n * Check attachments uploaded with multipart-form.\n */\n\"use strict\";\n\nconst Mongoose = require(\"mongoose\");\n\nmodule.exports = function (payload, instance, schema, errors) {\n\n    let isUpdate = false;\n    if (instance) { // update operation\n        isUpdate = true;\n    }\n\n    Object.keys(schema.tree).forEach((key) => {\n\n        const schemaItem = schema.tree[key];\n\n        if (schemaItem.type == Mongoose.SchemaTypes.Image\n            || schemaItem.type == Mongoose.SchemaTypes.File) {\n\n            const isRequired = schemaItem.required;\n\n            if (!payload[key]) {\n                // skip fot not included record keys\n            }\n            if (!payload[key].filename || !payload[key].path) {\n\n                if (isRequired && !isUpdate) {\n                    errors.push({\n                        key: key,\n                        msg: \"can not be blank.\"\n                    });\n                }\n                else if (isRequired && isUpdate && !instance[key]) {\n                    errors.push({\n                        key: key,\n                        msg: \"can not be blank.\"\n                    });\n                }\n                delete payload[key];\n            }\n            else {\n                if (schemaItem.type == Mongoose.SchemaTypes.Image) {\n\n                    const contentTypes = payload[key][\"headers\"][\"content-type\"].split(\"/\");\n                    if (contentTypes[0] != \"image\") {\n                        delete payload[key];\n                        errors.push({\n                            key: key,\n                            msg: \"uploaded file not an image.\"\n                        });\n                    }\n                    else if ([\"jpg\", \"jpeg\", \"png\"].indexOf(contentTypes[1].toLocaleLowerCase()) == -1) {\n                        delete payload[key];\n                        errors.push({\n                            key: key,\n                            msg: \"uploaded file not a valid image, expected: jpg or png.\"\n                        });\n                    }\n                }\n                if (schemaItem.type == Mongoose.SchemaTypes.File) {\n\n                    const filenameParts = payload[key].filename.split(\".\");\n                    const ext = filenameParts.pop();\n\n                    let expected = schemaItem.extension;\n                    if (!(schemaItem.extension instanceof Array)) {\n                        expected = [expected];\n                    }\n\n                    if (expected.indexOf(ext) == -1) {\n                        delete payload[key];\n                        errors.push({\n                            key: key,\n                            msg: \"uploaded file has wrong type, expected: \" + schemaItem.kind\n                        });\n                    }\n                }\n            }\n        }\n    });\n};"]}
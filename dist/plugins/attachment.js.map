{"version":3,"sources":["../../src/plugins/attachment.js"],"names":[],"mappings":"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","file":"attachment.js","sourcesContent":["/**\n *\n * Updated by uur on 12/01/16.\n */\n\n\"use strict\";\n\nconst Async = require(\"async\");\nconst Forklift = require(\"s3-forklift\");\nconst FileUploader = require(\"./uploader/file_uploader\");\nconst ImageUploader = require(\"./uploader/image_uploader\");\nconst CheckAttachments = require(\"./validation/check_attachments\");\n\n/**\n * @param schema\n * @param options\n */\n\nmodule.exports = (schema, options) => {\n\n    const mongoose = options.mongoose;\n    const s3 = options.s3;\n\n    if (!s3 || !mongoose) {\n        console.log(\"Options passed to mechanic-mongoose does not contain s3 credentials.\");\n    }\n\n    schema.statics.checkAttachments = (payload, instance, schema, errors) => {\n\n        CheckAttachments(mongoose, payload, instance, schema, errors);\n        return errors;\n    };\n\n\n    const schemaItems = Object.keys(schema.tree);\n\n    const attachments = {\n        images: [],\n        files: []\n    };\n\n    for (let schemaItem of schemaItems) {\n\n        /**\n         *\n         * test_image: {\n         *    type: mongoose.Schema.Types.Image,\n         *    versions: {\n         *       main: {\n         *           size: \"1920x1080\",\n         *           resize: \">\",\n         *           output: \"jpeg\"\n         *       },\n         *       display2: \"960x\",\n         *       display3: \"x960\"\n         *     }\n         * }\n         *\n         *    available resize options: <,!,>\n         *    available outputs: \"jpeg\", \"jpg\", \"png\"\n         *\n         *\n         *\n         * test_file {\n         *    type: mongoose.Schema.Types.File,\n         *    extension: [\"pdf\"]\n         * }\n         *\n         *\n         */\n\n        if (schema.tree[schemaItem].type == mongoose.Schema.Types[\"Image\"]) {\n\n            const versions = schema.tree[schemaItem][\"versions\"] || {};\n\n            if (typeof versions === \"string\" || versions instanceof String) {\n\n                attachments.images.push({\n                    schemaKey: schemaItem,\n                    versions: [\n                        {[\"main\"]: _transformImageDesc(versions, schemaItem)}\n                    ]\n                });\n                continue;\n            }\n\n            const versionKeys = Object.keys(versions);\n            if (versionKeys.indexOf(\"original\") != -1) {\n                throw new Error(`${schemaItem} contains 'original' key which do not valid.`);\n            }\n\n            const images = [];\n            for (let versionKey of versionKeys) {\n\n                if (versionKey == \"type\") {\n                    continue;\n                }\n\n                images.push({[versionKey]: _transformImageDesc(versions[versionKey], schemaItem)});\n            }\n\n            attachments.images.push({\n                schemaKey: schemaItem,\n                versions: images\n            });\n\n        }\n        else if (schema.tree[schemaItem].type == mongoose.Schema.Types[\"File\"]) {\n\n            attachments.files.push({\n                schemaKey: schemaItem,\n                extensions: _transformFileTypes(schema.tree[schemaItem][\"extension\"])\n            });\n        }\n    }\n\n    const forklift = new Forklift(s3);\n\n    schema.pre(\"save\", function (next) {\n\n        const instance = this;\n\n        const images = [];\n        const files = [];\n\n        for (let imageField of attachments.images) {\n\n            const schemaKey = imageField[\"schemaKey\"];\n\n            if (!instance[schemaKey] || !instance.isModified(schemaKey)) {\n                continue;\n            }\n\n            if (!instance[schemaKey].path || !instance[schemaKey].filename) {\n                console.log(`${schemaKey} is not valid in instance: ${instance[schemaKey]}`);\n                continue;\n            }\n\n            images.push({\n                versions: imageField[\"versions\"],\n                schemaKey: schemaKey\n            });\n        }\n\n        for (let fileField of attachments.files) {\n\n            const schemaKey = fileField[\"schemaKey\"];\n\n            if (!instance[schemaKey] || !instance.isModified(schemaKey)) {\n                continue;\n            }\n\n            if (!instance[schemaKey].path || !instance[schemaKey].filename) {\n                return next(new Error(`${schemaKey} is not valid in instance: ${instance[schemaKey]}`));\n            }\n\n            const ext = _getExtension(instance[schemaKey].filename);\n            const name = _getFileName(instance[schemaKey].filename);\n\n            if (fileField[\"extensions\"].indexOf(ext.toLocaleLowerCase()) == -1) {\n                return next(new Error(`${schemaKey} has not valid extension: ${ext}`));\n            }\n\n            files.push({\n                schemaKey: schemaKey,\n                name,\n                ext\n            });\n        }\n\n        Async.auto({\n\n            \"uploadFiles\": (autoCallback) => {\n\n                if (!attachments.files) {\n                    return autoCallback();\n                }\n                return FileUploader(forklift, instance, files, autoCallback);\n            },\n            \"uploadImages\": (autoCallback) => {\n\n                if (!attachments.images) {\n                    return autoCallback();\n                }\n                return ImageUploader(forklift, instance, images, autoCallback);\n            }\n        }, next);\n\n    });\n};\n\nfunction _transformFileTypes(extensions) {\n\n    if (typeof extensions === \"string\" || extensions instanceof String) {\n        return [extensions];\n    }\n    return extensions;\n}\n\nfunction _transformImageDesc(versionImage, schemaItem) {\n\n    const Image = {\n        output: \"jpeg\",\n        resize: \"!\"\n    };\n\n    if (typeof versionImage === \"string\" || versionImage instanceof String) {\n        Image[\"size\"] = _transformSize(versionImage, schemaItem);\n    }\n    else { // object\n        Image[\"size\"] = _transformSize(versionImage[\"size\"], schemaItem);\n        Image[\"output\"] = _transformOutput(versionImage[\"output\"], schemaItem);\n        Image[\"resize\"] = _transformResize(versionImage[\"resize\"], schemaItem);\n    }\n\n    return Image;\n}\n\nfunction _transformOutput(output, schemaItem) {\n\n    if (!output) {\n        return \"jpeg\";\n    }\n\n    if ([\"jpeg\", \"jpg\", \"png\"].indexOf(output) == -1) {\n        throw new Error(`schemaItem: ${schemaItem}, output:\"${output}\" is not valid`);\n    }\n\n    return output;\n}\n\nfunction _transformResize(resize, schemaItem) {\n\n    if (!resize) {\n        return \"!\";\n    }\n\n    if ([\">\", \"<\", \"!\"].indexOf(resize) == -1) {\n        throw new Error(`schemaItem: ${schemaItem}, resize:\"${resize}\" is not valid`);\n    }\n\n    return resize;\n}\n\nfunction _transformSize(size, schemaItem) {\n\n    if (!size) {\n        throw new Error(`schemaItem: ${schemaItem}, size is not exist in image.`);\n    }\n\n    if (size == \"keep\") {\n        return {\n            width: 0,\n            height: 0\n        }\n    }\n\n    const sizeArray = size.split(\"x\");\n    if (sizeArray.length != 2) {\n        throw new Error(`schemaItem: ${schemaItem}, size:\"${size}\" is not valid`);\n    }\n\n    let width;\n    let height;\n\n    try {\n        width = sizeArray[0] ? parseInt(sizeArray[0]) : null;\n        height = sizeArray[1] ? parseInt(sizeArray[1]) : null;\n    }\n    catch (e) {\n        throw new Error(`schemaItem: ${schemaItem}, ${size} is not valid`);\n    }\n\n    return {\n        width,\n        height\n    }\n\n}\n\nfunction _getFileName(fileName) {\n\n    try {\n        return fileName && fileName.split(\".\")[0]\n    }\n    catch (e) {\n        return \"\";\n    }\n}\n\nfunction _getExtension(fileName) {\n\n    try {\n        return fileName && fileName.split(\".\").pop()\n    }\n    catch (e) {\n        return \"\";\n    }\n}"]}
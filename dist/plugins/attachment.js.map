{"version":3,"sources":["../../src/plugins/attachment.js"],"names":[],"mappings":";;;;;AAKA,YAAY,CAAC;;AAEb,IAAM,KAAK,GAAG,OAAO,CAAC,OAAO,CAAC,CAAC;AAC/B,IAAM,QAAQ,GAAG,OAAO,CAAC,aAAa,CAAC,CAAC;AACxC,IAAM,YAAY,GAAG,OAAO,CAAC,0BAA0B,CAAC,CAAC;AACzD,IAAM,aAAa,GAAG,OAAO,CAAC,2BAA2B,CAAC,CAAC;AAC3D,IAAM,cAAc,GAAG,OAAO,CAAC,mBAAmB,CAAC;;;;;;;AAAC,AAOpD,MAAM,CAAC,OAAO,GAAG,UAAC,MAAM,EAAE,OAAO,EAAK;;AAElC,QAAM,EAAE,GAAG,OAAO,CAAC,EAAE,CAAC;;AAEtB,QAAI,CAAC,EAAE,EAAE;AACL,eAAO,CAAC,GAAG,CAAC,sEAAsE,CAAC,CAAC;KACvF;;AAED,QAAM,QAAQ,GAAG,IAAI,QAAQ,CAAC,EAAE,CAAC,CAAC;;AAElC,QAAM,QAAQ,YAAO,CAAC;;AAEtB,QAAM,WAAW,GAAG,EAAE,CAAC;AACvB,eAAW,CAAC,QAAQ,CAAC,GAAG,cAAc,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,IAAI,CAAC,CAAC;AACpE,eAAW,CAAC,OAAO,CAAC,GAAG,cAAc,CAAC,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,IAAI,CAAC,CAAC;;AAElE,UAAM,CAAC,GAAG,CAAC,MAAM,EAAE,UAAS,IAAI,EAAE;;AAE9B,YAAM,QAAQ,GAAG,IAAI,CAAC;;AAEtB,YAAM,WAAW,GAAG,EAAE;;;AAAC,AAGvB,mBAAW,CAAC,QAAQ,CAAC,GAAG,cAAc,CAAC,MAAM,EAAE,QAAQ,EAAE,OAAO,EAAE,IAAI,CAAC,CAAC;AACxE,mBAAW,CAAC,OAAO,CAAC,GAAG,cAAc,CAAC,MAAM,EAAE,QAAQ,EAAE,MAAM,EAAE,IAAI,CAAC,CAAC;;AAEtE,aAAK,CAAC,IAAI,CAAC;;AAEP,yBAAa,EAAE,qBAAC,YAAY,EAAK;;AAE7B,oBAAI,CAAC,WAAW,CAAC,KAAK,EAAE;AACpB,2BAAO,YAAY,EAAE,CAAC;iBACzB;AACD,4BAAY,CAAC,QAAQ,EAAE,WAAW,CAAC,KAAK,EAAE,YAAY,CAAC,CAAC;aAC3D;AACD,0BAAc,EAAE,sBAAC,YAAY,EAAK;;AAE9B,oBAAI,CAAC,WAAW,CAAC,MAAM,EAAE;AACrB,2BAAO,YAAY,EAAE,CAAC;iBACzB;AACD,4BAAY,CAAC,QAAQ,EAAE,WAAW,CAAC,MAAM,EAAE,YAAY,CAAC,CAAC;aAC5D;SACJ,EAAE,IAAI,CAAC,CAAC;KACZ,CAAC,CAAC;CACN,CAAC","file":"attachment.js","sourcesContent":["/**\n *\n * Updated by uur on 12/01/16.\n */\n\n\"use strict\";\n\nconst Async = require(\"async\");\nconst Forklift = require(\"s3-forklift\");\nconst FileUploader = require(\"./uploader/file_uploader\");\nconst ImageUploader = require(\"./uploader/image_uploader\");\nconst TraverseSchema = require(\"./traverse_schema\");\n\n/**\n * @param {Mongoose.Schema} schema\n * @param {{s3:{},Mongoose:Mongoose}} options\n*/\n\nmodule.exports = (schema, options) => {\n\n    const s3 = options.s3;\n\n    if (!s3) {\n        console.log(\"Options passed to mechanic-mongoose does not contain s3 credentials.\");\n    }\n\n    const forklift = new Forklift(s3);\n\n    const instance = this;\n\n    const attachments = {};\n    attachments[\"images\"] = TraverseSchema(schema, null, \"Image\", true);\n    attachments[\"files\"] = TraverseSchema(schema, null, \"File\", true);\n\n    schema.pre(\"save\", function(next) {\n\n        const instance = this;\n\n        const attachments = {};\n        // Collect attachments,\n\n        attachments[\"images\"] = TraverseSchema(schema, instance, \"Image\", true);\n        attachments[\"files\"] = TraverseSchema(schema, instance, \"File\", true);\n\n        Async.auto({\n\n            \"uploadFiles\": (autoCallback) => {\n\n                if (!attachments.files) {\n                    return autoCallback();\n                }\n                FileUploader(forklift, attachments.files, autoCallback);\n            },\n            \"uploadImages\": (autoCallback) => {\n\n                if (!attachments.images) {\n                    return autoCallback();\n                }\n                FileUploader(forklift, attachments.images, autoCallback);\n            }\n        }, next);\n    });\n};\n"]}